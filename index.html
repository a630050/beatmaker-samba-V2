<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SambaBeatmaker - 森巴鼓團練習程式(Pro)</title>

	<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.0/build/cjs/vexflow.min.js"></script>

    <link rel="stylesheet" href="css/styles.css">

</head>
<body>
    <div class="container">
		<div class="header">
			<div class="logo">🎵 Samba Beatmaker</div>
			
			<div class="metronome-lights" id="metronomeLightsContainer">
                <div class="metronome-light"></div>
                <div class="metronome-light"></div>
                <div class="metronome-light"></div>
                <div class="metronome-light"></div>
            </div>
			
			<div class="controls">

				<div class="control-group">
					<button class="btn btn-help" id="helpBtn">? 指引</button>
				</div>
				
				<div class="control-group">
                    <button class="btn btn-special" id="metronomeBtn" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">⏱️ 節拍器</button>
                </div>

				<div class="control-group">
					<button class="btn btn-special" id="soundAdjustBtn">🎵 調音</button>
				</div>

				<div class="control-group">
					<button class="btn" id="playBtn" title="播放/暫停 (Space 或 P)">▶ 播放</button>
				</div>

				<div class="control-group">
					<button class="btn btn-danger" id="resetBtn" title="重置鼓譜 (R)">重設</button>
				</div>

				<div class="control-group">
					<button class="btn btn-secondary" id="undoBtn" disabled title="上一步 (Ctrl + Z)">上一步</button>
					<button class="btn btn-secondary" id="redoBtn" disabled title="下一步 (Ctrl + Y 或 Ctrl + Shift + Z)">下一步</button>
				</div>

				<div class="control-group">
					 <button class="btn action-btn" id="selectBtn" title="切換選取模式 (E)">編輯</button>
				</div>

				<div id="selectionControls" class="selection-controls" style="display: none;">
					<button class="selection-btn" id="copySelectionBtn" title="複製選取範圍 (Ctrl + C)">複製</button>
					<button class="selection-btn" id="pasteSelectionBtn" title="貼上樣式 (Ctrl + V)">貼上</button>
					<button class="selection-btn" id="savePatternBtn">儲存樣式</button>
					<button class="selection-btn" id="loadPatternBtn">載入樣式</button>
                    <button class="selection-btn" id="convertNotationBtn">轉鼓譜</button>
					<input type="file" class="file-input" id="patternFileInput" accept=".pa">
				</div>

                <div class="control-group">
                    <button class="btn btn-marking" id="markBtn" title="切換標記模式 (M)">標記</button>
                </div>

				<div id="markerControls" class="marker-controls" style="display: none;">
					<button class="btn btn-marking" id="clearBtn">清除標記</button>
					<button class="marker-btn" data-marker="R">R</button>
					<button class="marker-btn" data-marker="L">L</button>
					<button class="marker-btn" data-marker="accent" data-value=">">&gt;</button>
					<button class="marker-btn" data-marker="accent" data-value="()">( )</button>
					<button class="marker-btn" data-marker="rest" data-value="-">-</button>
                    <button class="marker-btn active" data-marker="eraser">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
					</button>
				</div>

				<div class="control-group">
					<button class="btn btn-info" id="exportBtn" title="儲存鼓譜 (Ctrl + S)">存檔</button>
					<button class="btn btn-info" id="importBtn">載入</button>
					<button class="btn btn-info" id="exportMp3Btn">匯出MP3</button>
					<input type="file" class="file-input" id="fileInput" accept=".json">
				</div>

				<div class="control-group">
					<label for="loopCountSelect" style="color: white;">循環次數:</label>
					<select id="loopCountSelect" style="background: rgba(0,0,0,0.7); color: #00ff88; border: 1px solid #00ff88; border-radius: 5px; padding: 4px;">
						<option value="1" selected>1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
					</select>
				</div>

			</div>
		</div>

        <div class="control-row">
            <div class="mode-controls">
                <button class="mode-btn active" data-mode="ensemble">合奏</button>
                <button class="mode-btn" data-mode="sequential">輪奏</button>
            </div>
            <div class="beat-setting-controls">
                <span class="beat-setting-label">一拍長度:</span>
                <button class="beat-setting-btn" data-beat-setting="2">2格</button>
                <button class="beat-setting-btn active" data-beat-setting="4">4格</button>
                <button class="beat-setting-btn" data-beat-setting="8">8格</button>
            </div>
			<div class="expand-controls">
                <button class="expand-btn reduce-start" id="reduceStartBtn" title="從開頭減少4拍">-</button>
				<button class="expand-btn" id="expandBtn" title="增加4拍">+</button>
				<button class="expand-btn reduce" id="reduceEndBtn" title="從結尾減少4拍">-</button>
				<div class="beats-info-container">
					<span class="beat-setting-label">節拍長度：</span>
					<span class="beats-info" id="beatsInfo">8拍</span>
				</div>
			</div>
            <div class="bpm-control">
                <span>BPM:</span>
                <input type="number" class="bpm-input" id="bpmInput" value="65" min="40" max="200">
            </div>
			<div class="bpm-control">
				<span>音量:</span>
				<input type="number" class="bpm-input" id="globalVolumeInput" value="80" min="0" max="100">
				<span style="margin-left: -10px;">%</span>
			</div>
            <div class="checkbox-container">
                <input type="checkbox" class="checkbox" id="showNumbers">
                <label for="showNumbers">拍數顯示</label>
            </div>
			<div class="checkbox-container">
                <input type="checkbox" class="checkbox" id="showMarkersCheckbox">
                <label for="showMarkersCheckbox">LR顯示</label>
            </div>
			<div class="checkbox-container">
				<input type="checkbox" class="checkbox" id="showAccentsCheckbox" checked>
				<label for="showAccentsCheckbox">記號顯示</label>
			</div>
			<div class="beat-setting-controls">
                <span class="beat-setting-label">色差提示:</span>
                <button class="beat-setting-btn color-hint-btn" data-hint-mode="lr">左右</button>
                <button class="beat-setting-btn color-hint-btn" data-hint-mode="accent">強弱</button>
            </div>

        </div>

		<div class="sequencer">
			<div class="tracks-controls" id="tracksControls">
				<div id="trackControls"></div>
				<div class="tracks-footer-controls">
					<button class="collapse-btn" id="addTrackBtn" title="新增軌道">➕</button>
					<button class="collapse-btn" id="collapseBtn" title="摺疊/展開控製麵板">◀</button>
				</div>
			</div>

			<div class="tracks-sequencer">
				<div class="position-indicator" id="positionIndicator">
					<div class="position-line" id="positionLine"></div>
				</div>
				<div id="trackSteps"></div>
			</div>
		</div>

		<div class="author-credit">
        程式作者：徐承佑 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  森巴鼓指導老師：陳仰真
		</div>
    </div>

	<div class="modal-overlay" id="soundPanelOverlay">
		<div class="sound-panel" id="soundAdjustPanel">
			<h3 style="margin-bottom: 20px; color: #00ff88; text-align: center;">🎵 樂器音色調整</h3>
			<div class="global-accent-controls">
				<h4 style="color: #00ff88; margin-bottom: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">
					全域記號音量調整
				</h4>
				<div class="accent-controls-wrapper">
					<div class="accent-slider-container">
						<label for="accentVolumeSlider">強音 (>) 音量: <span id="accentVolumeDisplay">500</span>%</label>
						<input type="range" id="accentVolumeSlider" min="100" max="1000" value="500" step="50">
					</div>
					<div class="accent-slider-container">
						<label for="ghostVolumeSlider">弱音 ( ) 音量: <span id="ghostVolumeDisplay">30</span>%</label>
						<input type="range" id="ghostVolumeSlider" min="0" max="100" value="30" step="5">
					</div>
				</div>
			</div>
			<div class="sound-controls-grid" id="soundControlsContainer">
			</div>
			<div class="panel-buttons">
				<button class="btn" id="closeSoundPanel">關閉</button>
				<button class="btn warning" id="resetSounds">重設音色</button>
			</div>
		</div>
	</div>

    <div id="helpModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h1>Samba Beatmaker - 使用說明</h1>
                <button id="closeHelpModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="helpFrame" src="readme-dark.html" frameborder="0"></iframe>
            </div>
        </div>
    </div>

	 <div id="notationModal" class="modal-overlay">
			<div class="modal-content">
				<div class="modal-header">
					<h3>鼓譜轉換結果</h3>
					<div class="notation-controls">
						<button class="btn" id="notationPlayBtn">▶ 播放</button>
						<button class="btn" id="notationPrintBtn">🖨 列印</button>
						<input type="checkbox" id="showBeatHintCheckbox" class="checkbox" checked>
						<label for="showBeatHintCheckbox">拍號提示</label>
					</div>
					<button id="closeNotationModal" class="close-btn">&times;</button>
				</div>
				<div class="modal-body" id="notationContent">
					<!-- JS will populate this -->
				</div>
        </div>
    </div>

    <div id="metronomeModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; height: auto;">
            <div class="modal-header">
                <h3>⏱️ 節拍器設定</h3>
                <button id="closeMetronomeModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px; overflow-y: auto;">
                <div class="metronome-settings-container">
                    
                    <div class="metronome-setting-group">
                        <h4 class="setting-title">節拍器</h4>
                        <div class="sound-mode-selector" style="border: none; padding: 0; margin-bottom: 0;">
                            <label>
                                <input type="radio" name="metronome-enabled" value="true" checked>
                                <span>啟用</span>
                            </label>
                            <label>
                                <input type="radio" name="metronome-enabled" value="false">
                                <span>不啟用</span>
                            </label>
                        </div>
                    </div>

                    <div class="metronome-setting-group">
                        <h4 class="setting-title">模式</h4>
                        <div class="sound-mode-selector" style="border: none; padding: 0; margin-bottom: 0;">
                            <label>
                                <input type="radio" name="metronome-mode" value="sequential" checked>
                                <span>輪播</span>
                            </label>
                            <label>
                                <input type="radio" name="metronome-mode" value="single">
                                <span>單一</span>
                            </label>
                            <label>
                                <input type="radio" name="metronome-mode" value="conductor">
                                <span>指揮</span>
                            </label>
                        </div>
                    </div>

                    <div class="metronome-setting-group">
                        <h4 class="setting-title">燈色</h4>
                        <div class="color-options">
                            <button class="color-preset-btn" data-color="#00ff88" style="background-color: #00ff88;"></button>
                            <button class="color-preset-btn" data-color="#3498db" style="background-color: #3498db;"></button>
                            <button class="color-preset-btn" data-color="#e74c3c" style="background-color: #e74c3c;"></button>
                            <button class="color-preset-btn" data-color="#f1c40f" style="background-color: #f1c40f;"></button>
                            <input type="color" id="metronomeColorPicker" value="#00ff88">
                        </div>
                    </div>

                    <div class="metronome-setting-group">
                        <h4 class="setting-title">聲音</h4>
                        <select id="metronomeSoundSelect" class="drum-select" style="flex: initial; width: 150px;">
                            <option value="tick" selected>電子音 (高)</option>
                            <option value="tock">電子音 (低)</option>
                            <option value="woodblock">合成木魚</option>
                            <option value="cowbell">合成牛鈴</option>
                            <option value="shaker">沙鈴</option>
                            <option value="none">無聲</option>
                        </select>
                    </div>

                    <div class="metronome-setting-group">
                        <h4 class="setting-title">音量</h4>
                        <div class="volume-control" style="flex: 1;">
                            <input type="range" class="volume-slider" id="metronomeVolumeSlider" min="0" max="1" step="0.05" value="0.7">
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
	
	<script src="js/percussion-test.js" defer></script>
	<script src="js/beatmaker.js" defer></script>
	
	<!-- ====================================================== -->
	<!-- START: 打擊測試模組 (Percussion Test Module) Modal    -->
	<!-- ====================================================== -->
	<div id="testModal" class="modal-overlay">
		<div class="modal-content test-modal-content">
			<div class="modal-header">
				<h3 id="testModalTitle">打擊音軌測試</h3>
				<div class="test-controls">
					<input type="checkbox" id="highPrecisionToggle" class="checkbox">
					<label for="highPrecisionToggle">開啓高精度測試</label>
				</div>
				<button id="closeTestModal" class="close-btn">&times;</button>
			</div>
			<div class="modal-body test-modal-body">
				<div class="test-grid-container">
					<h4>目標音格</h4>
					<div class="test-grid-wrapper">
						<div class="prep-grid">
							<div class="test-cell prep-cell">預</div>
							<div class="test-cell prep-cell">備</div>
							<div class="test-cell prep-cell">拍</div>
							<div class="test-cell prep-cell">點</div>
						</div>
						<div id="targetGrid" class="test-grid"></div>
					</div>
				</div>
				<div class="test-grid-container">
					<h4>記錄音格</h4>
					<div class="test-grid-wrapper">
						 <div class="prep-grid">
							<div class="test-cell"></div>
							<div class="test-cell"></div>
							<div class="test-cell"></div>
							<div class="test-cell"></div>
						</div>
						<div id="recordGrid" class="test-grid"></div>
					</div>
				</div>

				<div id="testStatus" class="test-status-display">請點擊下方按鈕開始</div>

				<div class="test-results">
					<div id="scoreDisplay" class="score-display">--</div>
					<div class="deviation-summary">
						<p>精準: <span id="perfectCount">0</span></p>
						<p>過早: <span id="earlyCount">0</span></p>
						<p>過晚: <span id="lateCount">0</span></p>
						<p>失誤: <span id="missedCount">0</span></p>
						<p>左右手: <span id="handAccuracyDisplay">--%</span></p>
					</div>
				</div>

			</div>
			<div class="modal-footer test-modal-footer">
				<div class="footer-placeholder"></div> <!-- 這個 div 是空的，只用來佔位 -->
				<div> 
					<button id="stopTestBtn" class="btn btn-danger" style="display: none;">停止測試</button>
					<button id="startTestBtn" class="btn btn-special">點擊開始測試</button>
					<button id="repeatTestBtn" class="btn btn-info" style="display: none;">再次測試</button>
				</div>
			</div>
		</div>
	</div>
	<!-- ====================================================== -->
	<!-- END: 打擊測試模組 (Percussion Test Module) Modal      -->
	<!-- ====================================================== -->
</body>
</html>
